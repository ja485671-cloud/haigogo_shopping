<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ­¡æ¨‚å…¨çƒè³¼ </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --gold: #c9a96e;
  --gold-light: #e8d5b0;
  --gold-dark: #a07840;
  --ink: #1a1208;
  --paper: #faf8f3;
  --paper-dark: #f0ece0;
  --red: #c0392b;
  --green: #27ae60;
  --shadow: 0 4px 24px rgba(26,18,8,0.10);
  --shadow-lg: 0 8px 40px rgba(26,18,8,0.16);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Noto Sans TC', sans-serif;
  background: var(--paper);
  color: var(--ink);
  min-height: 100vh;
}

/* ===== HEADER ===== */
.site-header {
  background: var(--ink);
  padding: 0;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 20px rgba(0,0,0,0.3);
}
.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 28px;
  border-bottom: 1px solid rgba(201,169,110,0.2);
}
.logo {
  font-family: 'Noto Serif TC', serif;
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--gold);
  letter-spacing: 0.05em;
}
.logo span { color: #fff; font-weight: 400; font-size: 0.9rem; display: block; letter-spacing: 0.12em; margin-top: 1px; }

.header-actions { display: flex; align-items: center; gap: 16px; }

.search-wrap {
  position: relative;
  display: flex;
  align-items: center;
}
.search-input {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(201,169,110,0.3);
  border-radius: 24px;
  padding: 8px 40px 8px 16px;
  color: #fff;
  font-size: 0.85rem;
  font-family: 'Noto Sans TC', sans-serif;
  width: 220px;
  outline: none;
  transition: all 0.2s;
}
.search-input::placeholder { color: rgba(255,255,255,0.35); }
.search-input:focus { background: rgba(255,255,255,0.12); border-color: var(--gold); width: 260px; }
.search-icon {
  position: absolute;
  right: 12px;
  color: rgba(201,169,110,0.7);
  font-size: 1rem;
  pointer-events: none;
}

.cart-btn {
  background: var(--gold);
  color: var(--ink);
  border: none;
  border-radius: 24px;
  padding: 8px 18px;
  font-family: 'Noto Sans TC', sans-serif;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.2s;
  white-space: nowrap;
}
.cart-btn:hover { background: var(--gold-light); }
.cart-count {
  background: var(--red);
  color: #fff;
  border-radius: 50%;
  width: 20px; height: 20px;
  font-size: 0.7rem;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700;
}

/* ===== FILTER BAR ===== */
.filter-bar {
  background: #222010;
  padding: 10px 28px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  overflow-x: auto;
}
.filter-label { color: rgba(201,169,110,0.6); font-size: 0.75rem; white-space: nowrap; }

.filter-select {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(201,169,110,0.25);
  border-radius: 20px;
  padding: 6px 14px;
  color: #fff;
  font-size: 0.82rem;
  font-family: 'Noto Sans TC', sans-serif;
  outline: none;
  cursor: pointer;
  transition: border-color 0.2s;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23c9a96e'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 28px;
}
.filter-select:focus { border-color: var(--gold); }
.filter-select option { background: #1a1208; color: #fff; }

.filter-tag {
  background: rgba(201,169,110,0.15);
  border: 1px solid rgba(201,169,110,0.3);
  border-radius: 20px;
  padding: 5px 14px;
  color: var(--gold-light);
  font-size: 0.78rem;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.filter-tag:hover, .filter-tag.active {
  background: var(--gold);
  color: var(--ink);
  border-color: var(--gold);
}

.result-count {
  margin-left: auto;
  color: rgba(255,255,255,0.4);
  font-size: 0.78rem;
  white-space: nowrap;
}

/* ===== MIN ORDER NOTICE ===== */
.notice-bar {
  background: linear-gradient(90deg, #2a1f00, #1a1208);
  border-bottom: 1px solid rgba(201,169,110,0.15);
  padding: 8px 28px;
  display: none;
  align-items: center;
  gap: 10px;
}
.notice-bar.show { display: flex; }
.notice-icon { color: var(--gold); font-size: 1rem; }
.notice-text { color: var(--gold-light); font-size: 0.82rem; }

/* ===== MAIN LAYOUT ===== */
.main {
  max-width: 1400px;
  margin: 0 auto;
  padding: 28px 28px;
}

/* ===== LOADING ===== */
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  gap: 16px;
}
.spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--gold-light);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: var(--gold-dark); font-size: 0.9rem; }

/* ===== PRODUCT GRID ===== */
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 18px;
}

.product-card {
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  display: flex;
  flex-direction: column;
  border: 1px solid rgba(201,169,110,0.1);
}
.product-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.product-img {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  background: var(--paper-dark);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  position: relative;
}
.product-img img {
  width: 100%; height: 100%;
  object-fit: cover;
}
.product-img-placeholder {
  width: 100%;
  aspect-ratio: 1;
  background: linear-gradient(135deg, var(--paper-dark) 0%, #e8e0cc 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  color: var(--gold);
}

.product-badge {
  position: absolute;
  top: 8px; left: 8px;
  background: var(--red);
  color: #fff;
  font-size: 0.62rem;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 10px;
  letter-spacing: 0.03em;
}
.product-badge.type-special { background: var(--gold-dark); }
.product-badge.type-discount { background: #2980b9; }

.product-info {
  padding: 12px;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.product-name {
  font-size: 0.82rem;
  font-weight: 500;
  line-height: 1.4;
  color: var(--ink);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.product-note {
  font-size: 0.7rem;
  color: var(--red);
  line-height: 1.3;
}
.product-price-row {
  display: flex;
  align-items: baseline;
  gap: 6px;
  margin-top: auto;
}
.product-price {
  font-size: 1rem;
  font-weight: 700;
  color: var(--gold-dark);
  font-family: 'Noto Serif TC', serif;
}
.product-pv {
  font-size: 0.72rem;
  color: #888;
}

.add-btn {
  margin: 0 12px 12px;
  background: var(--ink);
  color: var(--gold);
  border: none;
  border-radius: 8px;
  padding: 8px;
  font-size: 0.8rem;
  font-family: 'Noto Sans TC', sans-serif;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.2s;
  letter-spacing: 0.05em;
}
.add-btn:hover { background: var(--gold); color: var(--ink); }

/* ===== PRODUCT DETAIL MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26,18,8,0.75);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 20px;
  backdrop-filter: blur(3px);
}
.modal-overlay.show { display: flex; }

.modal {
  background: #fff;
  border-radius: 16px;
  max-width: 560px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 24px 80px rgba(0,0,0,0.4);
  animation: modalIn 0.25s ease;
}
@keyframes modalIn { from { opacity:0; transform: scale(0.95) translateY(16px); } to { opacity:1; transform: none; } }

.modal-img {
  width: 100%;
  aspect-ratio: 16/9;
  background: var(--paper-dark);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 4rem;
  color: var(--gold);
  border-radius: 16px 16px 0 0;
  overflow: hidden;
}
.modal-img img { width: 100%; height: 100%; object-fit: cover; }

.modal-body { padding: 24px; }
.modal-country-type { display: flex; gap: 8px; margin-bottom: 10px; }
.modal-tag {
  font-size: 0.72rem;
  padding: 3px 10px;
  border-radius: 12px;
  font-weight: 600;
}
.modal-tag.country { background: var(--ink); color: var(--gold); }
.modal-tag.type { background: var(--paper-dark); color: var(--gold-dark); }

.modal-name {
  font-family: 'Noto Serif TC', serif;
  font-size: 1.25rem;
  font-weight: 700;
  line-height: 1.4;
  margin-bottom: 8px;
}
.modal-id { font-size: 0.75rem; color: #aaa; margin-bottom: 12px; }
.modal-note {
  background: #fff5f5;
  border-left: 3px solid var(--red);
  padding: 8px 12px;
  border-radius: 0 8px 8px 0;
  font-size: 0.8rem;
  color: var(--red);
  margin-bottom: 14px;
}
.modal-desc {
  font-size: 0.85rem;
  line-height: 1.8;
  color: #555;
  margin-bottom: 16px;
}
.modal-price-row {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 14px 0;
  border-top: 1px solid var(--paper-dark);
  border-bottom: 1px solid var(--paper-dark);
  margin-bottom: 20px;
}
.modal-price { font-size: 1.6rem; font-weight: 700; color: var(--gold-dark); font-family: 'Noto Serif TC', serif; }
.modal-pv { font-size: 0.85rem; color: #888; }

.qty-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.qty-label { font-size: 0.85rem; color: #555; }
.qty-ctrl { display: flex; align-items: center; gap: 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
.qty-btn {
  background: var(--paper-dark);
  border: none;
  width: 36px; height: 36px;
  font-size: 1.1rem;
  cursor: pointer;
  color: var(--ink);
  transition: background 0.15s;
}
.qty-btn:hover { background: var(--gold-light); }
.qty-num {
  width: 44px;
  text-align: center;
  font-size: 1rem;
  font-weight: 700;
  border: none;
  outline: none;
  font-family: 'Noto Sans TC', sans-serif;
}

.modal-add-btn {
  width: 100%;
  background: var(--ink);
  color: var(--gold);
  border: none;
  border-radius: 10px;
  padding: 14px;
  font-size: 1rem;
  font-weight: 700;
  font-family: 'Noto Sans TC', sans-serif;
  cursor: pointer;
  letter-spacing: 0.06em;
  transition: background 0.2s;
}
.modal-add-btn:hover { background: var(--gold); color: var(--ink); }
.modal-close {
  position: absolute;
  top: 16px; right: 16px;
  background: rgba(0,0,0,0.5);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 32px; height: 32px;
  font-size: 1.1rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.modal-close:hover { background: rgba(0,0,0,0.8); }
.modal-wrap { position: relative; }

/* ===== CART PANEL ===== */
.cart-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26,18,8,0.6);
  z-index: 300;
  backdrop-filter: blur(2px);
}
.cart-overlay.show { display: block; }

.cart-panel {
  position: fixed;
  top: 0; right: -500px;
  width: 480px;
  max-width: 100vw;
  height: 100vh;
  background: #fff;
  z-index: 301;
  box-shadow: -8px 0 40px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  transition: right 0.3s cubic-bezier(0.4,0,0.2,1);
  overflow: hidden;
}
.cart-panel.open { right: 0; }

.cart-header {
  background: var(--ink);
  padding: 20px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.cart-title { font-family: 'Noto Serif TC', serif; font-size: 1.1rem; font-weight: 700; color: var(--gold); }
.cart-close {
  background: none;
  border: none;
  color: rgba(255,255,255,0.6);
  font-size: 1.3rem;
  cursor: pointer;
  padding: 4px;
  transition: color 0.2s;
}
.cart-close:hover { color: #fff; }

.cart-country-badge {
  background: linear-gradient(90deg, #2a1f00, #1a1208);
  padding: 10px 24px;
  font-size: 0.82rem;
  color: var(--gold-light);
  border-bottom: 1px solid rgba(201,169,110,0.15);
  display: none;
}
.cart-country-badge.show { display: block; }

.cart-items {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.cart-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 12px;
  color: #bbb;
}
.cart-empty-icon { font-size: 3rem; }
.cart-empty-text { font-size: 0.9rem; }

.cart-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--paper);
  border-radius: 10px;
  border: 1px solid var(--paper-dark);
}
.cart-item-img {
  width: 52px; height: 52px;
  border-radius: 8px;
  background: var(--paper-dark);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem;
  flex-shrink: 0;
  overflow: hidden;
}
.cart-item-img img { width: 100%; height: 100%; object-fit: cover; }
.cart-item-info { flex: 1; min-width: 0; }
.cart-item-name { font-size: 0.8rem; font-weight: 500; line-height: 1.3; margin-bottom: 3px; }
.cart-item-price { font-size: 0.8rem; color: var(--gold-dark); font-weight: 700; }
.cart-item-qty { display: flex; align-items: center; gap: 4px; }
.cart-item-qty-btn {
  background: var(--paper-dark);
  border: none;
  width: 26px; height: 26px;
  border-radius: 6px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: background 0.15s;
}
.cart-item-qty-btn:hover { background: var(--gold-light); }
.cart-item-qty-num { width: 28px; text-align: center; font-size: 0.85rem; font-weight: 700; }
.cart-item-remove {
  background: none; border: none;
  color: #ccc; font-size: 1rem; cursor: pointer;
  padding: 4px; transition: color 0.15s;
}
.cart-item-remove:hover { color: var(--red); }

.cart-footer {
  background: var(--paper);
  border-top: 1px solid var(--paper-dark);
  padding: 16px 24px;
}
.cart-summary { margin-bottom: 14px; }
.cart-summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 0.85rem;
  color: #666;
}
.cart-summary-row.total {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--ink);
  padding-top: 8px;
  border-top: 1px solid #ddd;
  margin-top: 4px;
}
.cart-summary-row.total .val { color: var(--gold-dark); font-size: 1.2rem; font-family: 'Noto Serif TC', serif; }

.cart-min-warning {
  background: #fff5f5;
  border: 1px solid #ffcccc;
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 0.78rem;
  color: var(--red);
  margin-bottom: 12px;
  display: none;
}
.cart-min-warning.show { display: block; }

.checkout-btn {
  width: 100%;
  background: var(--gold);
  color: var(--ink);
  border: none;
  border-radius: 10px;
  padding: 14px;
  font-size: 1rem;
  font-weight: 700;
  font-family: 'Noto Sans TC', sans-serif;
  cursor: pointer;
  letter-spacing: 0.06em;
  transition: background 0.2s;
}
.checkout-btn:hover { background: var(--gold-dark); color: #fff; }
.clear-cart-btn {
  width: 100%;
  background: none;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 10px;
  font-size: 0.82rem;
  color: #888;
  cursor: pointer;
  font-family: 'Noto Sans TC', sans-serif;
  margin-top: 8px;
  transition: all 0.2s;
}
.clear-cart-btn:hover { border-color: var(--red); color: var(--red); }

/* ===== CHECKOUT FORM MODAL ===== */
.checkout-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26,18,8,0.8);
  z-index: 400;
  align-items: center;
  justify-content: center;
  padding: 20px;
  backdrop-filter: blur(4px);
}
.checkout-overlay.show { display: flex; }

.checkout-modal {
  background: #fff;
  border-radius: 16px;
  max-width: 600px;
  width: 100%;
  max-height: 92vh;
  overflow-y: auto;
  box-shadow: 0 24px 80px rgba(0,0,0,0.5);
  animation: modalIn 0.25s ease;
}
.checkout-header {
  background: var(--ink);
  padding: 20px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-radius: 16px 16px 0 0;
}
.checkout-title { font-family: 'Noto Serif TC', serif; font-size: 1.1rem; color: var(--gold); font-weight: 700; }
.checkout-close {
  background: none; border: none; color: rgba(255,255,255,0.6); font-size: 1.3rem; cursor: pointer;
}
.checkout-close:hover { color: #fff; }

.checkout-body { padding: 24px 28px; }
.form-section { margin-bottom: 22px; }
.form-section-title {
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--gold-dark);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 12px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--paper-dark);
}
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row.single { grid-template-columns: 1fr; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 0.78rem; color: #666; font-weight: 500; }
.form-input, .form-select {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 9px 12px;
  font-size: 0.88rem;
  font-family: 'Noto Sans TC', sans-serif;
  outline: none;
  transition: border-color 0.2s;
  color: var(--ink);
  background: #fff;
}
.form-input:focus, .form-select:focus { border-color: var(--gold); }
.form-input::placeholder { color: #bbb; }

.order-preview {
  background: var(--paper);
  border-radius: 10px;
  padding: 16px;
  font-size: 0.82rem;
  line-height: 1.8;
  color: #555;
  white-space: pre-wrap;
  font-family: 'Noto Sans TC', sans-serif;
  border: 1px solid var(--paper-dark);
  margin-bottom: 16px;
  max-height: 200px;
  overflow-y: auto;
}

.generate-btn {
  width: 100%;
  background: var(--gold);
  color: var(--ink);
  border: none;
  border-radius: 10px;
  padding: 13px;
  font-size: 0.95rem;
  font-weight: 700;
  font-family: 'Noto Sans TC', sans-serif;
  cursor: pointer;
  letter-spacing: 0.05em;
  transition: background 0.2s;
  margin-bottom: 10px;
}
.generate-btn:hover { background: var(--gold-dark); color: #fff; }

.copy-btn {
  width: 100%;
  background: var(--ink);
  color: var(--gold);
  border: none;
  border-radius: 10px;
  padding: 13px;
  font-size: 0.95rem;
  font-weight: 700;
  font-family: 'Noto Sans TC', sans-serif;
  cursor: pointer;
  letter-spacing: 0.05em;
  transition: background 0.2s;
  display: none;
}
.copy-btn.show { display: block; }
.copy-btn:hover { background: var(--gold); color: var(--ink); }
.copy-btn.copied { background: var(--green); color: #fff; }

/* ===== CONFLICT WARNING MODAL ===== */
.conflict-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26,18,8,0.75);
  z-index: 500;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.conflict-overlay.show { display: flex; }
.conflict-modal {
  background: #fff;
  border-radius: 14px;
  max-width: 400px;
  width: 100%;
  padding: 28px;
  text-align: center;
  box-shadow: 0 24px 60px rgba(0,0,0,0.35);
  animation: modalIn 0.2s ease;
}
.conflict-icon { font-size: 2.5rem; margin-bottom: 12px; }
.conflict-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; color: var(--ink); }
.conflict-msg { font-size: 0.85rem; color: #666; line-height: 1.6; margin-bottom: 20px; }
.conflict-btns { display: flex; gap: 10px; }
.conflict-btn {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Noto Sans TC', sans-serif;
  transition: all 0.2s;
}
.conflict-btn.cancel { background: var(--paper); border: 1px solid #ddd; color: #666; }
.conflict-btn.cancel:hover { border-color: #bbb; }
.conflict-btn.clear { background: var(--red); border: none; color: #fff; }
.conflict-btn.clear:hover { background: #a93226; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--ink);
  color: var(--gold);
  padding: 10px 22px;
  border-radius: 24px;
  font-size: 0.85rem;
  font-weight: 500;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  z-index: 600;
  transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ===== EMPTY STATE ===== */
.empty-state {
  grid-column: 1/-1;
  text-align: center;
  padding: 60px 20px;
  color: #bbb;
}
.empty-state-icon { font-size: 3rem; margin-bottom: 12px; }

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  .header-top { padding: 12px 16px; }
  .logo { font-size: 1.1rem; }
  .search-input { width: 150px; }
  .search-input:focus { width: 180px; }
  .filter-bar { padding: 8px 16px; }
  .main { padding: 16px; }
  .product-grid { grid-template-columns: repeat(auto-fill, minmax(155px, 1fr)); gap: 12px; }
  .cart-panel { width: 100vw; }
  .form-row { grid-template-columns: 1fr; }
  .checkout-body { padding: 20px 18px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="site-header">
  <div class="header-top">
    <div class="logo">
      æ­¡æ¨‚å…¨çƒè³¼
      
    </div>
    <div class="header-actions">
      <div class="search-wrap">
        <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹ç”¢å“â€¦">
        <span class="search-icon">ğŸ”</span>
      </div>
      <button class="cart-btn" onclick="toggleCart()">
        ğŸ›’ è³¼ç‰©è»Š
        <span class="cart-count" id="cartCount">0</span>
      </button>
    </div>
  </div>
  <div class="filter-bar" id="filterBar">
    <span class="filter-label">åœ‹å®¶</span>
    <select class="filter-select" id="countrySelect">
      <option value="">å…¨éƒ¨åœ‹å®¶</option>
    </select>
    <span class="filter-label">å“é¡</span>
    <select class="filter-select" id="categorySelect">
      <option value="">å…¨éƒ¨å“é¡</option>
    </select>
    <span class="result-count" id="resultCount"></span>
  </div>
</header>

<!-- MIN ORDER NOTICE -->
<div class="notice-bar" id="noticeBar">
  <span class="notice-icon">â„¹ï¸</span>
  <span class="notice-text" id="noticeText"></span>
</div>

<!-- MAIN -->
<main class="main">
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">è¼‰å…¥ç”¢å“è³‡æ–™ä¸­â€¦</div>
  </div>
  <div class="product-grid" id="productGrid" style="display:none"></div>
</main>

<!-- PRODUCT DETAIL MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="handleModalOverlayClick(event)">
  <div class="modal-wrap">
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div class="modal" id="modal">
      <div class="modal-img" id="modalImg"></div>
      <div class="modal-body">
        <div class="modal-country-type" id="modalTags"></div>
        <div class="modal-name" id="modalName"></div>
        <div class="modal-id" id="modalId"></div>
        <div class="modal-note" id="modalNote" style="display:none"></div>
        <div class="modal-desc" id="modalDesc"></div>
        <div class="modal-price-row">
          <div>
            <div class="modal-price" id="modalPrice"></div>
            <div class="modal-pv" id="modalPv"></div>
          </div>
        </div>
        <div class="qty-row">
          <span class="qty-label">æ•¸é‡</span>
          <div class="qty-ctrl">
            <button class="qty-btn" onclick="changeQty(-1)">âˆ’</button>
            <input class="qty-num" id="modalQty" type="number" value="1" min="1" max="99" readonly>
            <button class="qty-btn" onclick="changeQty(1)">ï¼‹</button>
          </div>
        </div>
        <button class="modal-add-btn" id="modalAddBtn" onclick="addToCartFromModal()">åŠ å…¥è³¼ç‰©è»Š</button>
      </div>
    </div>
  </div>
</div>

<!-- CART PANEL -->
<div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
<div class="cart-panel" id="cartPanel">
  <div class="cart-header">
    <div class="cart-title">ğŸ›’ è³¼ç‰©è»Š</div>
    <button class="cart-close" onclick="toggleCart()">âœ•</button>
  </div>
  <div class="cart-country-badge" id="cartCountryBadge"></div>
  <div class="cart-items" id="cartItems">
    <div class="cart-empty">
      <div class="cart-empty-icon">ğŸ›ï¸</div>
      <div class="cart-empty-text">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>
    </div>
  </div>
  <div class="cart-footer">
    <div class="cart-summary" id="cartSummary"></div>
    <div class="cart-min-warning" id="cartMinWarning"></div>
    <button class="checkout-btn" onclick="openCheckout()">å¡«å¯«è¨‚å–®è³‡æ–™</button>
    <button class="clear-cart-btn" onclick="clearCart()">æ¸…ç©ºè³¼ç‰©è»Š</button>
  </div>
</div>

<!-- CONFLICT WARNING -->
<div class="conflict-overlay" id="conflictOverlay">
  <div class="conflict-modal">
    <div class="conflict-icon">âš ï¸</div>
    <div class="conflict-title">åœ‹å®¶ä¸ç¬¦</div>
    <div class="conflict-msg" id="conflictMsg"></div>
    <div class="conflict-btns">
      <button class="conflict-btn cancel" onclick="closeConflict()">ä¿ç•™åŸè¨‚å–®</button>
      <button class="conflict-btn clear" onclick="clearAndAdd()">æ¸…ç©ºä¸¦åŠ å…¥æ–°ç”¢å“</button>
    </div>
  </div>
</div>

<!-- CHECKOUT MODAL -->
<div class="checkout-overlay" id="checkoutOverlay">
  <div class="checkout-modal">
    <div class="checkout-header">
      <div class="checkout-title">ğŸ“‹ å¡«å¯«è¨‚å–®è³‡æ–™</div>
      <button class="checkout-close" onclick="closeCheckout()">âœ•</button>
    </div>
    <div class="checkout-body">
      <div class="form-section">
        <div class="form-section-title">è¨‚å–®æ¨™é¡Œè³‡è¨Š</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">å®¢äººå§“å *</label>
            <input class="form-input" id="f_name"  oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label class="form-label">è¨‚å–®ç·¨è™Ÿ *</label>
            <input class="form-input" id="f_ordernum"  oninput="updatePreview()">
          </div>
        </div>
        <div class="form-row single" style="margin-top:10px">
          <div class="form-group">
            <label class="form-label">è³¼è²·åœ‹å®¶</label>
            <select class="form-select" id="f_country" onchange="updatePreview()">
              <option value="éŸ“åœ‹">éŸ“åœ‹</option>
              <option value="æ—¥æœ¬">æ—¥æœ¬</option>
              <option value="é¦¬ä¾†è¥¿äº">é¦¬ä¾†è¥¿äº</option>
              <option value="ç¾åœ‹">ç¾åœ‹</option>
              <option value="é¦™æ¸¯">é¦™æ¸¯</option>
              <option value="ç´è¥¿è˜­">ç´è¥¿è˜­</option>
              <option value="æ¾³æ´²">æ¾³æ´²</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">æœƒå“¡è³‡æ–™</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ï¼ˆ1ï¼‰ä¸‹å–®æœƒå“¡å§“å *</label>
            <input class="form-input" id="f_member_name" oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label class="form-label">ï¼ˆ2ï¼‰ä¸‹å–®æœƒå“¡ç·¨è™Ÿ *</label>
            <input class="form-input" id="f_member_id" oninput="updatePreview()">
          </div>
        </div>
        <div class="form-row" style="margin-top:10px">
          <div class="form-group">
            <label class="form-label">ï¼ˆ3ï¼‰ç™»å…¥å¯†ç¢¼ *</label>
            <input class="form-input" id="f_password" type="password" oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label class="form-label">ï¼ˆ4ï¼‰æŒ‡å®šæ¥­ç¸¾æ—¥æœŸ</label>
            <input class="form-input" id="f_date" type="date" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">7-11 æ”¶ä»¶è³‡è¨Š</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">æ”¶ä»¶äººå§“å</label>
            <input class="form-input" id="f_recv_name" oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label class="form-label">æ”¶ä»¶äººé›»è©±</label>
            <input class="form-input" id="f_recv_phone" oninput="updatePreview()">
          </div>
        </div>
        <div class="form-row" style="margin-top:10px">
          <div class="form-group">
            <label class="form-label">åº—å</label>
            <input class="form-input" id="f_store_name" oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label class="form-label">åº—è™Ÿ</label>
            <input class="form-input" id="f_store_num" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">ï¼ˆ9ï¼‰å‚™è¨»</div>
        <div class="form-group">
          <textarea class="form-input" id="f_remark" rows="2"  oninput="updatePreview()" style="resize:vertical"></textarea>
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">è¨‚å–®é è¦½</div>
        <div class="order-preview" id="orderPreview">å¡«å¯«ä¸Šæ–¹è³‡æ–™å¾Œï¼Œè¨‚å–®å…§å®¹å°‡è‡ªå‹•å‡ºç¾åœ¨é€™è£¡â€¦</div>
        <button class="generate-btn" onclick="generateOrder()">ç”¢ç”Ÿè¨‚å–®</button>
        <button class="copy-btn" id="copyBtn" onclick="copyOrder()">è¤‡è£½è¨‚å–®ï¼ˆè²¼åˆ° LINEï¼‰</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
// ===== CONFIG =====
const SHEET_ID = '1iu7_CAaPMRi5c0lB649jXgTAlD-vPCTM9melAaH7PIU';
const GID = '2087310803';// å·¥ä½œè¡¨1çš„GID

const MIN_ORDERS = {
  'éŸ“åœ‹': 1800, 'æ—¥æœ¬': 2600, 'é¦¬ä¾†è¥¿äº': 2800,
  'ç¾åœ‹': 6000, 'é¦™æ¸¯': 2800, 'ç´è¥¿è˜­': 0, 'æ¾³æ´²': 0
};
const MIN_SPECIAL = 3000;

// ===== STATE =====
let allProducts = [];
let filteredProducts = [];
let cart = [];
let cartCountry = '';
let currentModal = null;
let pendingAdd = null;
let generatedOrder = '';

// ===== LOAD DATA =====
function loadData() {
  const loading = document.getElementById('loading');
  const grid = document.getElementById('productGrid');
  if (loading) loading.style.display = 'flex';
  if (grid) grid.style.display = 'none';

  // 8 ç§’é€¾æ™‚æç¤º
  const timer = setTimeout(() => {
    const el = document.getElementById('loading');
    if (el) {
      el.style.display = 'flex';
      el.innerHTML = `
        <div style="color:#c0392b;text-align:center;padding:20px;line-height:1.7">
          <div style="font-weight:700;font-size:1rem">âš ï¸ è¼‰å…¥é€¾æ™‚</div>
          <div style="color:#888;font-size:0.85rem;margin-top:8px;white-space:pre-wrap">
Google Sheet æ²’æœ‰å›æ‡‰ã€‚è«‹ç¢ºèªï¼š
- Sheet å·²ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€
- ä½¿ç”¨çš„æ˜¯æ­£ç¢ºå·¥ä½œè¡¨ GID
- ä¸æ˜¯éœ€è¦ç™»å…¥æ‰èƒ½çœ‹
          </div>
        </div>
      `;
    }
  }, 8000);
  window.__gviz_timer = timer;

  // âœ… æ­£è¦è¼‰å…¥ Google Visualization
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(() => {
    const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq?gid=${encodeURIComponent(GID)}&tqx=out:json`;
    console.log('[GVIZ] Query URL:', url);

    const query = new google.visualization.Query(url);
    query.send((response) => {
      console.log('[GVIZ] response received');
      onSheetData(response); // ç›´æ¥ä¸Ÿå›ä½ åŸæœ¬çš„è§£ææµç¨‹
    });
  });
}

window.onSheetData = function(response) {
  try {
    if (window.__gviz_timer) clearTimeout(window.__gviz_timer);

    // âœ… QueryResponse æ­£ç¢ºéŒ¯èª¤åˆ¤æ–·
    if (response.isError && response.isError()) {
      const el = document.getElementById('loading');
      if (el) {
        el.style.display = 'flex';
        el.innerHTML = `<div style="color:#c0392b;text-align:center;padding:20px;line-height:1.7">
          <div style="font-weight:700;font-size:1rem">âš ï¸ Google Sheet å›å‚³éŒ¯èª¤</div>
          <div style="text-align:left;white-space:pre-wrap;color:#666;font-size:12px;margin-top:10px">${response.getMessage()}</div>
        </div>`;
      }
      return;
    }

    // âœ… QueryResponse æ­£ç¢ºå–è¡¨æ–¹å¼
    const dataTable = response.getDataTable();
    if (!dataTable || dataTable.getNumberOfColumns() === 0) {
      const el = document.getElementById('loading');
      if (el) {
        el.style.display = 'flex';
        el.innerHTML = `<div style="color:#c0392b;text-align:center;padding:20px;line-height:1.7">
          <div style="font-weight:700;font-size:1rem">âš ï¸ è³‡æ–™ä¸å­˜åœ¨</div>
          <div style="color:#888;font-size:0.85rem;margin-top:8px;white-space:pre-wrap">
è«‹ç¢ºèªï¼š
- ä½ é¸çš„æ˜¯æœ‰è³‡æ–™çš„å·¥ä½œè¡¨ï¼ˆGIDï¼‰
- ç¬¬ä¸€åˆ—æœ‰æ¬„ä½æ¨™é¡Œ
          </div>
        </div>`;
      }
      return;
    }

    // âœ… headers
    const headers = [];
    for (let i = 0; i < dataTable.getNumberOfColumns(); i++) {
      headers.push((dataTable.getColumnLabel(i) || '').trim());
    }

    // âœ… rows
    const rows = [];
    for (let r = 0; r < dataTable.getNumberOfRows(); r++) {
      const obj = {};
      for (let c = 0; c < headers.length; c++) {
        const v = dataTable.getValue(r, c);
        obj[headers[c]] = (v === null || v === undefined) ? '' : String(v);
      }
      rows.push(obj);
    }

    // ï¼ˆå¯é¸ï¼‰çœ‹æŠ“åˆ°å“ªäº›æ¬„ä½
    console.log('[GVIZ] headers:', headers);
    console.log('[GVIZ] rows:', rows.length);

    // âœ… æ¬„åå°é½Šï¼šé¡å‹ -> å“é¡ï¼ˆé¿å…ä½ ä¸‹æ‹‰ç”¨å“é¡ä½†è³‡æ–™å«é¡å‹ï¼‰
    rows.forEach(p => { if (!p['å“é¡'] && p['é¡å‹']) p['å“é¡'] = p['é¡å‹']; });

    // âœ… å¿…è¦æ¬„ä½æª¢æŸ¥ï¼ˆå“é¡å¯ç”¨é¡å‹æ›¿ä»£ï¼‰
    const required = ['ç”¢å“åç¨±','åœ‹å®¶','å“é¡','å°å¹£åƒ¹æ ¼','PV'];
    const missing = required.filter(k => !headers.includes(k) && !(k === 'å“é¡' && headers.includes('é¡å‹')));
    if (missing.length) {
      const el = document.getElementById('loading');
      if (el) {
        el.style.display = 'flex';
        el.innerHTML = `<div style="color:#c0392b;text-align:center;padding:20px;line-height:1.7">
          <div style="font-weight:700;font-size:1rem">âš ï¸ æ¬„ä½åç¨±å°ä¸ä¸Š</div>
          <div style="color:#888;font-size:0.85rem;margin-top:8px;white-space:pre-wrap">
ç¼ºå°‘æ¬„ä½ï¼š${missing.join('ã€')}

ç›®å‰æŠ“åˆ°çš„æ¬„åï¼š
${headers.join(' | ')}
          </div>
        </div>`;
      }
      return;
    }

    // âœ… é€²å…¥ä½ åŸæœ¬çš„æµç¨‹
    allProducts = rows
      .filter(p => (p['ç”¢å“åç¨±'] || '').trim())
      .filter(p => !('æ˜¯å¦ä¸Šæ¶' in p) || p['æ˜¯å¦ä¸Šæ¶'] !== 'å¦');

    initFilters();
    applyFilters();
    updateNotice();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('productGrid').style.display = 'grid';

  } catch (e) {
    const el = document.getElementById('loading');
    if (el) {
      el.style.display = 'flex';
      el.innerHTML = `<div style="color:#c0392b;text-align:center;padding:20px;line-height:1.7">
        <div style="font-weight:700;font-size:1rem">âš ï¸ è³‡æ–™è§£æå¤±æ•—</div>
        <div style="color:#888;font-size:0.85rem;margin-top:8px;white-space:pre-wrap">${e && e.message ? e.message : String(e)}</div>
      </div>`;
    }
  }
};
// ===== FILTERS =====
function initFilters() {
  const countries = [...new Set(allProducts.map(p => p['åœ‹å®¶']).filter(Boolean))];
  const countryOrder = ['éŸ“åœ‹','æ—¥æœ¬','é¦¬ä¾†è¥¿äº','ç¾åœ‹','é¦™æ¸¯','ç´è¥¿è˜­','æ¾³æ´²'];
  const sortedCountries = countryOrder.filter(c => countries.includes(c));

  const cs = document.getElementById('countrySelect');
  sortedCountries.forEach(c => {
    const o = document.createElement('option');
    o.value = c; o.textContent = c;
    cs.appendChild(o);
  });

  cs.addEventListener('change', () => { updateCategoryOptions(); applyFilters(); updateNotice(); });
  document.getElementById('categorySelect').addEventListener('change', applyFilters);
  document.getElementById('searchInput').addEventListener('input', applyFilters);

  updateCategoryOptions();
}

function updateCategoryOptions() {
  const country = document.getElementById('countrySelect').value;
  const cs = document.getElementById('categorySelect');
  const prev = cs.value;
  cs.innerHTML = '<option value="">å…¨éƒ¨å“é¡</option>';

  let prods = country ? allProducts.filter(p => p['åœ‹å®¶'] === country) : allProducts;
  const cats = [...new Set(prods.map(p => p['å“é¡']).filter(c => c))];
  const catOrder = ['ç‰¹æƒ çµ„','è¶…ç´šç‰¹æƒ å–®ç“¶åƒ¹','ä¿å¥é£Ÿå“ç³»åˆ—','è­·è†šç³»åˆ—','ç¾å¦é˜²æ›¬ç³»åˆ—','ç¾å¦çœ¼éƒ¨ç³»åˆ—','ç¾å¦è‡‰éƒ¨ç³»åˆ—','ç¾å¦å”‡éƒ¨ç³»åˆ—','ç¾å®¹é…ä»¶ç³»åˆ—','é ­é«®ç³»åˆ—','èº«é«”ç³»åˆ—','å£è…”ç³»åˆ—','æ¸…æ½”ç”¨å“ç³»åˆ—','å»šæˆ¿ç”¨å“ç³»åˆ—','é¦™æ°›ç³»åˆ—','å®¶å±…ç³»åˆ—','é£²å“ç³»åˆ—','é£Ÿå“ç³»åˆ—','èª¿å‘³æ–™ç³»åˆ—','å…§è¡£è¤²ç³»åˆ—','å…¶ä»–'];
  const sorted = catOrder.filter(c => cats.includes(c));
  sorted.forEach(c => {
    const o = document.createElement('option');
    o.value = c; o.textContent = c;
    if (c === prev) o.selected = true;
    cs.appendChild(o);
  });
}

function applyFilters() {
  const country = document.getElementById('countrySelect').value;
  const category = document.getElementById('categorySelect').value;
  const search = document.getElementById('searchInput').value.trim().toLowerCase();

  filteredProducts = allProducts.filter(p => {
    if (country && p['åœ‹å®¶'] !== country) return false;
    if (category && p['å“é¡'] !== category) return false;
    if (search && !p['ç”¢å“åç¨±'].toLowerCase().includes(search)) return false;
    return true;
  });

  renderProducts();
  document.getElementById('resultCount').textContent = `å…± ${filteredProducts.length} é …`;
}

function updateNotice() {
  const country = document.getElementById('countrySelect').value;
  const bar = document.getElementById('noticeBar');
  const txt = document.getElementById('noticeText');
  if (country && MIN_ORDERS[country] > 0) {
    txt.textContent = `ã€${country}ã€‘æœ€ä½è¨‚å–®é‡‘é¡ï¼šNT$${MIN_ORDERS[country].toLocaleString()}`;
    bar.classList.add('show');
  } else {
    bar.classList.remove('show');
  }
}

// ===== RENDER PRODUCTS =====
function getCategoryEmoji(cat) {
  const map = {
    'ä¿å¥é£Ÿå“ç³»åˆ—':'ğŸ’Š','è­·è†šç³»åˆ—':'âœ¨','ç¾å¦é˜²æ›¬ç³»åˆ—':'ğŸŒ','ç¾å¦çœ¼éƒ¨ç³»åˆ—':'ğŸ‘ï¸',
    'ç¾å¦è‡‰éƒ¨ç³»åˆ—':'ğŸ’„','ç¾å¦å”‡éƒ¨ç³»åˆ—':'ğŸ’‹','ç¾å®¹é…ä»¶ç³»åˆ—':'ğŸª','é ­é«®ç³»åˆ—':'ğŸ’†',
    'èº«é«”ç³»åˆ—':'ğŸ§´','å£è…”ç³»åˆ—':'ğŸ¦·','æ¸…æ½”ç”¨å“ç³»åˆ—':'ğŸ§¼','å»šæˆ¿ç”¨å“ç³»åˆ—':'ğŸ³',
    'é¦™æ°›ç³»åˆ—':'ğŸŒ¸','å®¶å±…ç³»åˆ—':'ğŸ ','é£²å“ç³»åˆ—':'ğŸ¥¤','é£Ÿå“ç³»åˆ—':'ğŸ½ï¸',
    'èª¿å‘³æ–™ç³»åˆ—':'ğŸ§‚','å…§è¡£è¤²ç³»åˆ—':'ğŸ‘—','ç‰¹æƒ çµ„':'ğŸ','è¶…ç´šç‰¹æƒ å–®ç“¶åƒ¹':'â­','å…¶ä»–':'ğŸ“¦'
  };
  return map[cat] || 'ğŸ“¦';
}

function getBadge(type) {
  if (type === 'ç‰¹æƒ çµ„') return '<div class="product-badge type-special">ç‰¹æƒ çµ„</div>';
  if (type === 'è¶…ç´šç‰¹æƒ å–®ç“¶åƒ¹') return '<div class="product-badge type-discount">å–®ç“¶ç‰¹æƒ </div>';
  return '';
}

function renderProducts() {
  const grid = document.getElementById('productGrid');
  if (filteredProducts.length === 0) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><div>æ‰¾ä¸åˆ°ç¬¦åˆçš„ç”¢å“</div></div>';
    return;
  }
  grid.innerHTML = filteredProducts.map((p, i) => {
    const emoji = getCategoryEmoji(p['å“é¡']);
    const imgHtml = p['åœ–ç‰‡ç¶²å€']
      ? `<img src="${p['åœ–ç‰‡ç¶²å€']}" alt="${p['ç”¢å“åç¨±']}" loading="lazy" onerror="this.parentElement.innerHTML='${emoji}'">`
      : emoji;
    const price = parseInt(p['å°å¹£åƒ¹æ ¼']) || 0;
    const pv = parseInt(p['PV']) || 0;
    return `
    <div class="product-card" onclick="openModal(${i})">
      <div class="product-img-placeholder" style="position:relative">
        ${p['åœ–ç‰‡ç¶²å€'] ? `<img src="${p['åœ–ç‰‡ç¶²å€']}" alt="${p['ç”¢å“åç¨±']}" loading="lazy" style="width:100%;height:100%;object-fit:cover;border-radius:12px 12px 0 0" onerror="this.outerHTML='<span style=font-size:2.5rem>${emoji}</span>'">` : `<span style="font-size:2.5rem">${emoji}</span>`}
        ${getBadge(p['é¡å‹'])}
      </div>
      <div class="product-info">
        <div class="product-name">${p['ç”¢å“åç¨±']}</div>
        ${p['å‚™è¨»'] ? `<div class="product-note">âš ï¸ ${p['å‚™è¨»'].split('ï¼›')[0]}</div>` : ''}
        <div class="product-price-row">
          <div class="product-price">NT$${price.toLocaleString()}</div>
          ${pv > 0 ? `<div class="product-pv">PV ${pv.toLocaleString()}</div>` : ''}
        </div>
      </div>
      <button class="add-btn" onclick="event.stopPropagation(); quickAdd(${i})">ï¼‹ åŠ å…¥è³¼ç‰©è»Š</button>
    </div>`;
  }).join('');
}

// ===== MODAL =====
function openModal(idx) {
  const p = filteredProducts[idx];
  currentModal = p;
  document.getElementById('modalQty').value = 1;

  const emoji = getCategoryEmoji(p['å“é¡']);
  const imgEl = document.getElementById('modalImg');
  if (p['åœ–ç‰‡ç¶²å€']) {
    imgEl.innerHTML = `<img src="${p['åœ–ç‰‡ç¶²å€']}" alt="${p['ç”¢å“åç¨±']}" onerror="this.outerHTML='<span style=font-size:4rem>${emoji}</span>'">`;
  } else {
    imgEl.innerHTML = `<span style="font-size:4rem">${emoji}</span>`;
  }

  document.getElementById('modalTags').innerHTML = `
    <span class="modal-tag country">${p['åœ‹å®¶']}</span>
    <span class="modal-tag type">${p['é¡å‹']} Â· ${p['å“é¡']}</span>
  `;
  document.getElementById('modalName').textContent = p['ç”¢å“åç¨±'];
  document.getElementById('modalId').textContent = p['å®˜ç¶²ç·¨è™Ÿ'] ? `å®˜ç¶²ç·¨è™Ÿï¼š${p['å®˜ç¶²ç·¨è™Ÿ']}` : '';

  const noteEl = document.getElementById('modalNote');
  if (p['å‚™è¨»']) {
    noteEl.textContent = 'âš ï¸ ' + p['å‚™è¨»'];
    noteEl.style.display = 'block';
  } else {
    noteEl.style.display = 'none';
  }

  document.getElementById('modalDesc').textContent = p['ç”¢å“ä»‹ç´¹'] || 'ï¼ˆè©³ç´°ä»‹ç´¹å¾…è£œå……ï¼‰';
  document.getElementById('modalPrice').textContent = `NT$${parseInt(p['å°å¹£åƒ¹æ ¼']).toLocaleString()}`;
  const pv = parseInt(p['PV']) || 0;
  document.getElementById('modalPv').textContent = pv > 0 ? `PV ${pv.toLocaleString()}` : '';

  document.getElementById('modalOverlay').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  document.body.style.overflow = '';
  currentModal = null;
}

function handleModalOverlayClick(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

function changeQty(delta) {
  const input = document.getElementById('modalQty');
  const v = Math.max(1, Math.min(99, parseInt(input.value) + delta));
  input.value = v;
}

function addToCartFromModal() {
  if (!currentModal) return;
  const qty = parseInt(document.getElementById('modalQty').value) || 1;
  tryAddToCart(currentModal, qty);
  closeModal();
}

function quickAdd(idx) {
  tryAddToCart(filteredProducts[idx], 1);
}

// ===== CART LOGIC =====
function tryAddToCart(product, qty) {
  const country = product['åœ‹å®¶'];
  if (cartCountry && cartCountry !== country) {
    pendingAdd = { product, qty };
    document.getElementById('conflictMsg').textContent =
      `æ‚¨çš„è³¼ç‰©è»Šç›®å‰ç‚ºã€${cartCountry}ã€‘è¨‚å–®ï¼Œç„¡æ³•åŠ å…¥ã€${country}ã€‘ç”¢å“ã€‚è«‹é¸æ“‡ä¿ç•™åŸè¨‚å–®ï¼Œæˆ–æ¸…ç©ºå¾ŒåŠ å…¥æ–°ç”¢å“ã€‚`;
    document.getElementById('conflictOverlay').classList.add('show');
    return;
  }
  addToCart(product, qty);
}

function addToCart(product, qty) {
  cartCountry = product['åœ‹å®¶'];
  const existing = cart.find(i => i.id === product['æµæ°´è™Ÿ']);
  if (existing) {
    existing.qty += qty;
  } else {
    cart.push({ id: product['æµæ°´è™Ÿ'], product, qty });
  }
  updateCartUI();
  showToast(`âœ“ å·²åŠ å…¥è³¼ç‰©è»Šï¼š${product['ç”¢å“åç¨±'].substring(0,15)}â€¦`);
}

function closeConflict() {
  pendingAdd = null;
  document.getElementById('conflictOverlay').classList.remove('show');
}

function clearAndAdd() {
  cart = [];
  cartCountry = '';
  document.getElementById('conflictOverlay').classList.remove('show');
  if (pendingAdd) {
    addToCart(pendingAdd.product, pendingAdd.qty);
    pendingAdd = null;
  }
}

function clearCart() {
  if (cart.length === 0) return;
  cart = [];
  cartCountry = '';
  updateCartUI();
  showToast('è³¼ç‰©è»Šå·²æ¸…ç©º');
}

function updateCartQty(id, delta) {
  const item = cart.find(i => i.id === id);
  if (!item) return;
  item.qty = Math.max(1, item.qty + delta);
  updateCartUI();
}

function removeFromCart(id) {
  cart = cart.filter(i => i.id !== id);
  if (cart.length === 0) cartCountry = '';
  updateCartUI();
}

function updateCartUI() {
  const total = cart.reduce((s, i) => s + parseInt(i.product['å°å¹£åƒ¹æ ¼']) * i.qty, 0);
  const totalPv = cart.reduce((s, i) => s + (parseInt(i.product['PV']) || 0) * i.qty, 0);
  const count = cart.reduce((s, i) => s + i.qty, 0);

  document.getElementById('cartCount').textContent = count;

  const badge = document.getElementById('cartCountryBadge');
  if (cartCountry) {
    badge.textContent = `ç›®å‰è¨‚å–®åœ‹å®¶ï¼šã€${cartCountry}ã€‘`;
    badge.classList.add('show');
  } else {
    badge.classList.remove('show');
  }

  const itemsEl = document.getElementById('cartItems');
  if (cart.length === 0) {
    itemsEl.innerHTML = '<div class="cart-empty"><div class="cart-empty-icon">ğŸ›ï¸</div><div class="cart-empty-text">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div></div>';
  } else {
    itemsEl.innerHTML = cart.map(item => {
      const p = item.product;
      const emoji = getCategoryEmoji(p['å“é¡']);
      const subtotal = parseInt(p['å°å¹£åƒ¹æ ¼']) * item.qty;
      return `
      <div class="cart-item">
        <div class="cart-item-img">
          ${p['åœ–ç‰‡ç¶²å€'] ? `<img src="${p['åœ–ç‰‡ç¶²å€']}" alt="" onerror="this.outerHTML='${emoji}'">` : emoji}
        </div>
        <div class="cart-item-info">
          <div class="cart-item-name">${p['ç”¢å“åç¨±']}</div>
          <div class="cart-item-price">NT$${subtotal.toLocaleString()}</div>
        </div>
        <div class="cart-item-qty">
          <button class="cart-item-qty-btn" onclick="updateCartQty('${item.id}',-1)">âˆ’</button>
          <span class="cart-item-qty-num">${item.qty}</span>
          <button class="cart-item-qty-btn" onclick="updateCartQty('${item.id}',1)">ï¼‹</button>
        </div>
        <button class="cart-item-remove" onclick="removeFromCart('${item.id}')">âœ•</button>
      </div>`;
    }).join('');
  }

  const summaryEl = document.getElementById('cartSummary');
  summaryEl.innerHTML = `
    <div class="cart-summary-row"><span>å°è¨ˆï¼ˆ${count} ä»¶ï¼‰</span><span>NT$${total.toLocaleString()}</span></div>
    <div class="cart-summary-row"><span>ç¸½ PV</span><span>${totalPv.toLocaleString()}</span></div>
    <div class="cart-summary-row total"><span>ç¸½é‡‘é¡</span><span class="val">NT$${total.toLocaleString()}</span></div>
  `;

  const minOrder = cartCountry ? (MIN_ORDERS[cartCountry] || 0) : 0;
  const warning = document.getElementById('cartMinWarning');
  if (minOrder > 0 && total < minOrder && cart.length > 0) {
    warning.textContent = `âš ï¸ ã€${cartCountry}ã€‘æœ€ä½è¨‚å–®é‡‘é¡ NT$${minOrder.toLocaleString()}ï¼Œç›®å‰å·® NT$${(minOrder - total).toLocaleString()}`;
    warning.classList.add('show');
  } else {
    warning.classList.remove('show');
  }
}

function toggleCart() {
  const panel = document.getElementById('cartPanel');
  const overlay = document.getElementById('cartOverlay');
  const isOpen = panel.classList.contains('open');
  panel.classList.toggle('open', !isOpen);
  overlay.classList.toggle('show', !isOpen);
  document.body.style.overflow = isOpen ? '' : 'hidden';
}

// ===== CHECKOUT =====
function openCheckout() {
  if (cart.length === 0) { showToast('è«‹å…ˆåŠ å…¥ç”¢å“'); return; }
  // é è¨­åœ‹å®¶
  const sel = document.getElementById('f_country');
  if (cartCountry) sel.value = cartCountry;
  toggleCart();
  document.getElementById('checkoutOverlay').classList.add('show');
  document.body.style.overflow = 'hidden';
  updatePreview();
}

function closeCheckout() {
  document.getElementById('checkoutOverlay').classList.remove('show');
  document.body.style.overflow = '';
  document.getElementById('copyBtn').classList.remove('show');
  generatedOrder = '';
}

function getTodayStr() {
  const d = new Date();
  return `${d.getMonth()+1}/${d.getDate()}`;
}

function updatePreview() {
  // å³æ™‚æ›´æ–°æ¨™é¡Œé è¦½
  const name = document.getElementById('f_name').value || 'ï¼ˆå§“åï¼‰';
  const num = document.getElementById('f_ordernum').value || 'ï¼ˆç·¨è™Ÿï¼‰';
  const country = document.getElementById('f_country').value || 'ï¼ˆåœ‹å®¶ï¼‰';
  const today = getTodayStr();
  const previewTitle = `æ™¯å„€åœ˜éšŠ-${name}${today}è¨‚å–®${num}${country}è³¼`;

  const preview = document.getElementById('orderPreview');
  preview.textContent = previewTitle + '\n\nï¼ˆé»ä¸‹æ–¹ã€Œç”¢ç”Ÿè¨‚å–®ã€æŒ‰éˆ•ç”¢ç”Ÿå®Œæ•´è¨‚å–®ï¼‰';
}

function generateOrder() {
  const name = document.getElementById('f_name').value;
  const num = document.getElementById('f_ordernum').value;
  const country = document.getElementById('f_country').value;
  const memberName = document.getElementById('f_member_name').value;
  const memberId = document.getElementById('f_member_id').value;
  const password = document.getElementById('f_password').value;
  const date = document.getElementById('f_date').value;
  const recvName = document.getElementById('f_recv_name').value;
  const recvPhone = document.getElementById('f_recv_phone').value;
  const storeName = document.getElementById('f_store_name').value;
  const storeNum = document.getElementById('f_store_num').value;
  const remark = document.getElementById('f_remark').value;

  if (!name || !num) { showToast('è«‹å¡«å¯«å§“åå’Œè¨‚å–®ç·¨è™Ÿ'); return; }

  const today = getTodayStr();
  const total = cart.reduce((s, i) => s + parseInt(i.product['å°å¹£åƒ¹æ ¼']) * i.qty, 0);
  const totalPv = cart.reduce((s, i) => s + (parseInt(i.product['PV']) || 0) * i.qty, 0);

  const productLines = cart.map(item =>
    `        ${item.product['ç”¢å“åç¨±']} x${item.qty}  NT$${(parseInt(item.product['å°å¹£åƒ¹æ ¼']) * item.qty).toLocaleString()}`
  ).join('\n');

  generatedOrder = `æ™¯å„€åœ˜éšŠ-${name}${today}è¨‚å–®${num}${country}è³¼

ï¼ˆ1ï¼‰ä¸‹å–®æœƒå“¡å§“åï¼š${memberName}
ï¼ˆ2ï¼‰ä¸‹å–®æœƒå“¡ç·¨è™Ÿï¼š${memberId}
ï¼ˆ3ï¼‰ç™»å…¥å¯†ç¢¼ï¼š${password}
ï¼ˆ4ï¼‰æŒ‡å®šæ¥­ç¸¾æ—¥æœŸï¼š${date || ''}
ï¼ˆ5ï¼‰è¨‚è³¼ç”¢å“é …ç›®åŠæ•¸é‡ï¼š
${productLines}

ï¼ˆ6ï¼‰ç¸½PVï¼š${totalPv.toLocaleString()}
ï¼ˆ7ï¼‰ç¸½é‡‘é¡ï¼šNT$${total.toLocaleString()}
ï¼ˆ8ï¼‰7-11æ”¶ä»¶è³‡è¨Šï¼š
          æ”¶ä»¶äººå§“åï¼š${recvName}
          æ”¶ä»¶äººé›»è©±ï¼š${recvPhone}
          åº—åï¼š${storeName}
          åº—è™Ÿï¼š${storeNum}
ï¼ˆ9ï¼‰å‚™è¨»ï¼š${remark}`;

  document.getElementById('orderPreview').textContent = generatedOrder;
  document.getElementById('copyBtn').classList.add('show');
}

function copyOrder() {
  if (!generatedOrder) return;
  navigator.clipboard.writeText(generatedOrder).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = 'âœ“ å·²è¤‡è£½ï¼è²¼åˆ° LINE ç™¼é€';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'è¤‡è£½è¨‚å–®ï¼ˆè²¼åˆ° LINEï¼‰';
      btn.classList.remove('copied');
    }, 2500);
  }).catch(() => {
    // fallback
    const ta = document.createElement('textarea');
    ta.value = generatedOrder;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('å·²è¤‡è£½ï¼');
  });
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

// ===== INIT =====
loadData();
</script>
</body>
</html>
